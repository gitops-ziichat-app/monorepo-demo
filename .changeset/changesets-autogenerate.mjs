import { getPackages } from '@manypkg/get-packages';
import { read as readConfig } from '@changesets/config';
import writeChangeset from '@changesets/write';
import readChangeset from '@changesets/read';
import { getDependentsGraph } from '@changesets/get-dependents-graph';
import path from 'path';
import fs from 'fs/promises';
import simpleGit from 'simple-git';

const cwd = process.cwd();
const git = simpleGit(cwd);

async function autogenerateChangeset() {
  const { packages, root } = await getPackages(cwd);
  const allPackages = root ? packages.concat(root) : packages;
  const dependentsGraph = await getDependentsGraph(allPackages);

  const diffSummary = await git.diffSummary();
  const changedFiles = diffSummary.files.map(f => f.file);

  if (changedFiles.length === 0) {
    console.log("No changed files detected. Skipping changeset generation.");
    return;
  }

  const changedPackageNames = new Set();
  for (const file of changedFiles) {
    const pkg = packages.find(p => file.startsWith(path.relative(cwd, p.dir)));
    if (pkg) {
      changedPackageNames.add(pkg.packageJson.name);
      // Add dependents of the changed package
      for (const [dependent, dependencies] of dependentsGraph.entries()) {
        if (dependencies.has(pkg.packageJson.name)) {
          changedPackageNames.add(dependent);
        }
      }
    }
  }

  if (changedPackageNames.size === 0) {
    console.log("No changes detected in any package. Skipping changeset generation.");
    return;
  }

  const existingChangesets = await readChangeset(cwd);
  if (existingChangesets.length > 0) {
    console.log("Existing changesets found. Skipping autogeneration.");
    return;
  }

  const releases = Array.from(changedPackageNames).map(name => {
    return { name, type: "patch" }; // Default to 'patch' for autogenerated changesets
  });

  const summary = "chore(release): bump version via CI";

  try {
    const changesetPath = await writeChangeset(summary, releases, { cwd });
    console.log(`Autogenerated changeset: ${path.basename(changesetPath)}`);
  } catch (error) {
    console.error("Failed to autogenerate changeset:", error);
    process.exit(1);
  }
}

autogenerateChangeset();




